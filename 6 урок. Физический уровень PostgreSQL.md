## 6 урок. Физический уровень PostgreSQL--------------------------------------------------------------

## Описание/Пошаговая инструкция выполнения домашнего задания:----------------------------------------------------

- создайте виртуальную машину c Ubuntu 20.04/22.04 LTS в GCE/ЯО/Virtual Box/докере поставьте на нее PostgreSQL 15 через sudo apt

```sh
root@artem-test-puppet:~# apt-get install postgresql-15
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following package was automatically installed and is no longer required:
  postgresql-client-16
Use 'apt autoremove' to remove it.
The following additional packages will be installed:
  postgresql-client-15
Suggested packages:
  postgresql-doc-15
The following NEW packages will be installed:
  postgresql-15 postgresql-client-15
0 upgraded, 2 newly installed, 0 to remove and 94 not upgraded.
Need to get 18.8 MB of archives.
After this operation, 62.6 MB of additional disk space will be used.
Do you want to continue? [Y/n] y
Get:1 https://repo.ocs.ru/repository/apt_postgresql jammy-pgdg/main amd64 postgresql-client-15 amd64 15.8-1.pgdg22.04+1 [1,689 kB]
Get:2 https://repo.ocs.ru/repository/apt_postgresql jammy-pgdg/main amd64 postgresql-15 amd64 15.8-1.pgdg22.04+1 [17.1 MB]
Fetched 18.8 MB in 2s (9,830 kB/s)
Preconfiguring packages ...
Selecting previously unselected package postgresql-client-15.
(Reading database ... 131966 files and directories currently installed.)
Preparing to unpack .../postgresql-client-15_15.8-1.pgdg22.04+1_amd64.deb ...
Unpacking postgresql-client-15 (15.8-1.pgdg22.04+1) ...
Selecting previously unselected package postgresql-15.
Preparing to unpack .../postgresql-15_15.8-1.pgdg22.04+1_amd64.deb ...
Unpacking postgresql-15 (15.8-1.pgdg22.04+1) ...
Setting up postgresql-client-15 (15.8-1.pgdg22.04+1) ...
Setting up postgresql-15 (15.8-1.pgdg22.04+1) ...
Creating new PostgreSQL cluster 15/main ...
/usr/lib/postgresql/15/bin/initdb -D /var/lib/postgresql/15/main --auth-local peer --auth-host scram-sha-256 --no-instructions
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/15/main ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Europe/Moscow
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok
Processing triggers for postgresql-common (260.pgdg22.04+1) ...
Building PostgreSQL dictionaries from installed myspell/hunspell packages...
Removing obsolete dictionary files:
Scanning processes...
Scanning candidates...
Scanning linux images...

Restarting services...
 /etc/needrestart/restart.d/systemd-manager
 systemctl restart ipmond.service packagekit.service ssh.service systemd-journald.service systemd-networkd.service systemd-resolved.service systemd-udevd.service udisks2.service upower.service zabbix-agent2.service
Service restarts being deferred:
 /etc/needrestart/restart.d/dbus.service
 systemctl restart getty@tty1.service
 systemctl restart networkd-dispatcher.service
 systemctl restart systemd-logind.service
 systemctl restart unattended-upgrades.service
 systemctl restart user@651833572.service

No containers need to be restarted.

No user sessions are running outdated binaries.

No VM guests are running outdated hypervisor (qemu) binaries on this host.
root@artem-test-puppet:~#
```
- проверьте что кластер запущен через sudo -u postgres pg_lsclusters

```sh
root@artem-test-puppet:~# sudo -u postgres pg_lsclusters
Ver Cluster Port Status Owner    Data directory              Log file
15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log
```

- зайдите из под пользователя postgres в psql и сделайте произвольную таблицу с произвольным содержимым
- postgres=# create table test(c1 text);
- postgres=# insert into test values('1');

```sh
root@artem-test-puppet:~# su postgres -c psql
psql (16.3 (Ubuntu 16.3-1.pgdg22.04+1), server 15.8 (Ubuntu 15.8-1.pgdg22.04+1))
Type "help" for help.

postgres=# create table test(c1 text);
CREATE TABLE
postgres=# insert into test values('1');
INSERT 0 1
postgres=# select * from test;
 c1
----
 1
(1 row)
```


- остановите postgres например через sudo -u postgres pg_ctlcluster 15 main stop

```sh
root@artem-test-puppet:~# sudo -u postgres pg_ctlcluster 15 main stop
root@artem-test-puppet:~# sudo -u postgres pg_lsclusters
Ver Cluster Port Status Owner    Data directory              Log file
15  main    5432 down   postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log
```

- создайте новый диск к ВМ размером 10GB

> СИТУАЦИЯ С ДИСКАМИ СЕЙЧАС:

```sh
root@artem-test-puppet:~# lsblk
NAME             MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0              7:0    0 111.9M  1 loop /snap/lxd/24322
loop1              7:1    0  63.4M  1 loop /snap/core20/1974
loop2              7:2    0  53.3M  1 loop /snap/snapd/19457
sda                8:0    0    40G  0 disk
├─sda1             8:1    0     1M  0 part
├─sda2             8:2    0     1G  0 part /boot
└─sda3             8:3    0    39G  0 part
  ├─vg00-lv_root 253:0    0    15G  0 lvm  /
  ├─vg00-lv_home 253:1    0     2G  0 lvm  /home
  ├─vg00-lv_opt  253:2    0     5G  0 lvm  /opt
  ├─vg00-lv_var  253:3    0     5G  0 lvm  /var
  └─vg00-lv_swap 253:4    0     4G  0 lvm  [SWAP]
```

> Добавил новый диск
```sh
root@artem-test-puppet:~# lsblk
NAME             MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0              7:0    0 111.9M  1 loop /snap/lxd/24322
loop1              7:1    0  63.4M  1 loop /snap/core20/1974
loop2              7:2    0  53.3M  1 loop /snap/snapd/19457
sda                8:0    0    40G  0 disk
├─sda1             8:1    0     1M  0 part
├─sda2             8:2    0     1G  0 part /boot
└─sda3             8:3    0    39G  0 part
  ├─vg00-lv_root 253:0    0    15G  0 lvm  /
  ├─vg00-lv_home 253:1    0     2G  0 lvm  /home
  ├─vg00-lv_opt  253:2    0     5G  0 lvm  /opt
  ├─vg00-lv_var  253:3    0     5G  0 lvm  /var
  └─vg00-lv_swap 253:4    0     4G  0 lvm  [SWAP]
sdc                8:32   0    10G  0 disk
```

- добавьте свеже-созданный диск к виртуальной машине - надо зайти в режим ее редактирования и дальше выбрать пункт attach existing disk
- проинициализируйте диск согласно инструкции и подмонтировать файловую систему, только не забывайте менять имя диска на актуальное, в вашем случае это скорее всего будет /dev/sdb - https://www.digitalocean.com/community/tutorials/how-to-partition-and-format-storage-devices-in-linux
- перезагрузите инстанс и убедитесь, что диск остается примонтированным (если не так смотрим в сторону fstab)

> СОЗДАЮ ДИСК

```sh
root@artem-test-puppet:~# vgcreate data /dev/sdc
  Volume group "data" successfully created
root@artem-test-puppet:~# vgs
  VG   #PV #LV #SN Attr   VSize   VFree
  data   1   0   0 wz--n- <10.00g <10.00g
  vg00   1   5   0 wz--n- <39.00g  <8.00g
root@artem-test-puppet:~# lvcreate -n lv_data -l 100%free data
  Logical volume "lv_data" created.
root@artem-test-puppet:~# lvs
  LV      VG   Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  lv_data data -wi-a----- <10.00g
  lv_home vg00 -wi-ao----   2.00g
  lv_opt  vg00 -wi-ao----   5.00g
  lv_root vg00 -wi-ao----  15.00g
  lv_swap vg00 -wi-ao----   4.00g
  lv_var  vg00 -wi-ao----   5.00g
root@artem-test-puppet:~# lsblk
NAME             MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0              7:0    0 111.9M  1 loop /snap/lxd/24322
loop1              7:1    0  63.4M  1 loop /snap/core20/1974
loop2              7:2    0  53.3M  1 loop /snap/snapd/19457
sda                8:0    0    40G  0 disk
├─sda1             8:1    0     1M  0 part
├─sda2             8:2    0     1G  0 part /boot
└─sda3             8:3    0    39G  0 part
  ├─vg00-lv_root 253:0    0    15G  0 lvm  /
  ├─vg00-lv_home 253:1    0     2G  0 lvm  /home
  ├─vg00-lv_opt  253:2    0     5G  0 lvm  /opt
  ├─vg00-lv_var  253:3    0     5G  0 lvm  /var
  └─vg00-lv_swap 253:4    0     4G  0 lvm  [SWAP]
sdc                8:32   0    10G  0 disk
└─data-lv_data   253:5    0    10G  0 lvm
root@artem-test-puppet:~# mkfs.ext4 /dev/data/lv_data
mke2fs 1.46.5 (30-Dec-2021)
Discarding device blocks: done
Creating filesystem with 2620416 4k blocks and 655360 inodes
Filesystem UUID: df5d0591-0904-4e05-abe1-d5cb2e03d65d
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632

Allocating group tables: done
Writing inode tables: done
Creating journal (16384 blocks): done
Writing superblocks and filesystem accounting information: done

root@artem-test-puppet:~# mount /dev/data/lv_data /mnt/data
root@artem-test-puppet:~# nano /etc/fstab
root@artem-test-puppet:~# cat /etc/fstab
# /etc/fstab: static file system information.
#
# Use 'blkid' to print the universally unique identifier for a
# device; this may be used with UUID= as a more robust way to name devices
# that works even if disks are added and removed. See fstab(5).
#
# <file system> <mount point>   <type>  <options>       <dump>  <pass>
/dev/vg00/lv_root / ext4 defaults 0 1
/dev/vg00/lv_home /home ext4 defaults 0 1
/dev/vg00/lv_opt /opt ext4 defaults 0 1
/dev/vg00/lv_var /var ext4 defaults 0 1
/dev/vg00/lv_swap none swap sw 0 0
/dev/sda2 /boot ext4 defaults 0 1
/dev/mapper/vg00-lv_swap        none    swap    sw,comment=cloudconfig  0       0
/dev/mapper/data-lv_data /mnt/data  ext4 defaults 0 0
```



- сделайте пользователя postgres владельцем /mnt/data chown -R postgres:postgres /mnt/data/

```sh
root@artem-test-puppet:~# chown -R postgres:postgres /mnt/data/
```

- перенесите содержимое /var/lib/postgres/15 в /mnt/data - mv /var/lib/postgresql/15/mnt/data

> ВЫКЛЮЧАЮ POSTGRES

```sh
root@artem-test-puppet:~# systemctl stop postgresql
root@artem-test-puppet:~# cd /var/lib/postgresql/15/main/
base/         pg_commit_ts/ pg_logical/   pg_notify/    pg_serial/    pg_stat/      pg_subtrans/  pg_twophase/  pg_xact/
global/       pg_dynshmem/  pg_multixact/ pg_replslot/  pg_snapshots/ pg_stat_tmp/  pg_tblspc/    pg_wal/
```

> ПЕРЕМЕЩАЮ ФАЙЛЫ НА НОВЫЙ ДИСК

```sh
root@artem-test-puppet:~# mv /var/lib/postgresql/15/main/ /mnt/data/
root@artem-test-puppet:~# ls -la /var/lib/postgresql/
15/            .bash_history  .psql_history
```

> ПРОВЕРЯЮ, ЧТО ПО СТАРОМУ ПУТИ ФАЙЛОВ НЕТ

```sh
root@artem-test-puppet:~# ls -la /var/lib/postgresql/15/
total 8
drwxr-xr-x 2 postgres postgres 4096 Sep 18 18:21 .
drwxr-xr-x 3 postgres postgres 4096 Sep 18 17:12 ..
root@artem-test-puppet:~# ls -la /mnt/data/
total 28
drwxr-xr-x  4 postgres postgres  4096 Sep 18 18:21 .
drwxr-xr-x  3 root     root      4096 Sep 18 17:23 ..
drwx------  2 postgres postgres 16384 Sep 18 17:53 lost+found
drwx------ 19 postgres postgres  4096 Sep 18 18:19 main
```

> ПРОВЕРЯЮ ЧТО ФАЙЛИ ПЕРЕНЕСЛИСЬ

```sh
root@artem-test-puppet:~# ls -la /mnt/data/main/
base/                 pg_dynshmem/          pg_notify/            pg_snapshots/         pg_subtrans/          PG_VERSION            postgresql.auto.conf
global/               pg_logical/           pg_replslot/          pg_stat/              pg_tblspc/            pg_wal/               postmaster.opts
pg_commit_ts/         pg_multixact/         pg_serial/            pg_stat_tmp/          pg_twophase/          pg_xact/
root@artem-test-puppet:~# ls -la /mnt/data/main/
total 88
drwx------ 19 postgres postgres 4096 Sep 18 18:19 .
drwxr-xr-x  4 postgres postgres 4096 Sep 18 18:21 ..
drwx------  5 postgres postgres 4096 Sep 18 17:12 base
drwx------  2 postgres postgres 4096 Sep 18 18:18 global
drwx------  2 postgres postgres 4096 Sep 18 17:12 pg_commit_ts
drwx------  2 postgres postgres 4096 Sep 18 17:12 pg_dynshmem
drwx------  4 postgres postgres 4096 Sep 18 18:19 pg_logical
drwx------  4 postgres postgres 4096 Sep 18 17:12 pg_multixact
drwx------  2 postgres postgres 4096 Sep 18 17:12 pg_notify
drwx------  2 postgres postgres 4096 Sep 18 17:12 pg_replslot
drwx------  2 postgres postgres 4096 Sep 18 17:12 pg_serial
drwx------  2 postgres postgres 4096 Sep 18 17:12 pg_snapshots
drwx------  2 postgres postgres 4096 Sep 18 18:19 pg_stat
drwx------  2 postgres postgres 4096 Sep 18 17:12 pg_stat_tmp
drwx------  2 postgres postgres 4096 Sep 18 17:12 pg_subtrans
drwx------  2 postgres postgres 4096 Sep 18 17:12 pg_tblspc
drwx------  2 postgres postgres 4096 Sep 18 17:12 pg_twophase
-rw-------  1 postgres postgres    3 Sep 18 17:12 PG_VERSION
drwx------  3 postgres postgres 4096 Sep 18 17:12 pg_wal
drwx------  2 postgres postgres 4096 Sep 18 17:12 pg_xact
-rw-------  1 postgres postgres   88 Sep 18 17:12 postgresql.auto.conf
-rw-------  1 postgres postgres  130 Sep 18 18:17 postmaster.opts
```


- попытайтесь запустить кластер - sudo -u postgres pg_ctlcluster 15 main start

```sh
root@artem-test-puppet:~# systemctl start postgresql
root@artem-test-puppet:~# systemctl status postgresql
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/lib/systemd/system/postgresql.service; enabled; vendor preset: enabled)
     Active: active (exited) since Wed 2024-09-18 18:23:50 MSK; 6s ago
    Process: 3019 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
   Main PID: 3019 (code=exited, status=0/SUCCESS)
        CPU: 1ms

Sep 18 18:23:50 artem-test-puppet systemd[1]: Starting PostgreSQL RDBMS...
Sep 18 18:23:50 artem-test-puppet systemd[1]: Finished PostgreSQL RDBMS.
root@artem-test-puppet:~# ^C
root@artem-test-puppet:~# mc
MoTTY X11 proxy: Unsupported authorisation protocol

root@artem-test-puppet:~# sudo -u postgres pg_lsclusters
Ver Cluster Port Status Owner     Data directory              Log file
15  main    5432 down   <unknown> /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log
root@artem-test-puppet:~#

root@artem-test-puppet:~# sudo -u postgres pg_ctlcluster 15 main start
Error: /var/lib/postgresql/15/main is not accessible or does not exist
```

- напишите получилось или нет и почему

> Не запустилось, так как в файле /etc/postgresql/15/main/postgresql.conf нужно поменять параметр data_directory с '/var/lib/postgresql/15/main' на /mnt/data/main/

```sh
root@artem-test-puppet:~# cat /etc/postgresql/15/main/postgresql.conf | grep /var/lib
data_directory = '/var/lib/postgresql/15/main'          # use data in another directory
```

- задание: найти конфигурационный параметр в файлах раположенных в /etc/postgresql/15/main который надо поменять и поменяйте его

> Не запустилось, так как в файле /etc/postgresql/15/main/postgresql.conf нужно поменять параметр data_directory с '/var/lib/postgresql/15/main' на /mnt/data/main/. Так как копировали файлы, то еще раз выдал права chown -R postgres:postgres /mnt/data/

- напишите что и почему поменяли

> Запустить кластер удалось таким образом:
```sh
root@artem-test-puppet:/var/log/postgresql# systemctl stop postgresql.service
root@artem-test-puppet:/var/log/postgresql# systemctl start postgresql.service
root@artem-test-puppet:/var/log/postgresql# systemctl status postgresql.service
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/lib/systemd/system/postgresql.service; enabled; vendor preset: enabled)
     Active: active (exited) since Wed 2024-09-18 18:36:29 MSK; 5s ago
    Process: 3735 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
   Main PID: 3735 (code=exited, status=0/SUCCESS)
        CPU: 1ms

Sep 18 18:36:29 artem-test-puppet systemd[1]: Starting PostgreSQL RDBMS...
Sep 18 18:36:29 artem-test-puppet systemd[1]: Finished PostgreSQL RDBMS.
root@artem-test-puppet:/var/log/postgresql# csystemctl status postgresql^C
root@artem-test-puppet:/var/log/postgresql# 
root@artem-test-puppet:/var/log/postgresql# 
root@artem-test-puppet:/var/log/postgresql# sudo journalctl -u postgresql.service -n 50 -f
Sep 18 18:36:29 artem-test-puppet systemd[1]: Starting PostgreSQL RDBMS...
Sep 18 18:36:29 artem-test-puppet systemd[1]: Finished PostgreSQL RDBMS.
root@artem-test-puppet:/var/log/postgresql# pg_isready
/var/run/postgresql:5432 - accepting connections
```

- ПРОВЕРЯЮ МОЖНО ЛИ ПОДКЛЮЧИТЬСЯ К ИНСТАНСУ ЧЕРЕЗ PSQL

```sh
root@artem-test-puppet:/var/log/postgresql# su postgres -c psql
psql (16.3 (Ubuntu 16.3-1.pgdg22.04+1), server 15.8 (Ubuntu 15.8-1.pgdg22.04+1))
Type "help" for help.

postgres=# \l
                                                       List of databases
   Name    |  Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | ICU Locale | ICU Rules |   Access privileges
-----------+----------+----------+-----------------+-------------+-------------+------------+-----------+-----------------------
 postgres  | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           |
 template0 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =c/postgres          +
           |          |          |                 |             |             |            |           | postgres=CTc/postgres
 template1 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =c/postgres          +
           |          |          |                 |             |             |            |           | postgres=CTc/postgres
(3 rows)

postgres=# select * from test;
 c1
----
 1
(1 row)

postgres=#
```

- попытайтесь запустить кластер - sudo -u postgres pg_ctlcluster 15 main start

> Вот так  sudo -u postgres pg_ctlcluster 15 main start  тоже получилось запустить

```sh
root@artem-test-puppet:/var/log/postgresql# sudo -u postgres pg_ctlcluster 15 main stop
root@artem-test-puppet:/var/log/postgresql#
root@artem-test-puppet:/var/log/postgresql# sudo -u postgres pg_lsclusters
Ver Cluster Port Status Owner    Data directory Log file
15  main    5432 down   postgres /mnt/data/main /var/log/postgresql/postgresql-15-main.log
root@artem-test-puppet:/var/log/postgresql# sudo -u postgres pg_ctlcluster 15 main start
Warning: the cluster will not be running as a systemd service. Consider using systemctl:
  sudo systemctl start postgresql@15-main
root@artem-test-puppet:/var/log/postgresql# sudo -u postgres pg_lsclusters
Ver Cluster Port Status Owner    Data directory Log file
15  main    5432 online postgres /mnt/data/main /var/log/postgresql/postgresql-15-main.log
```

- напишите получилось или нет и почему

> УДАЛОСЬ ПОДКЛЮЧИТЬСЯ К БАЗЕ 
- зайдите через через psql и проверьте содержимое ранее созданной таблицы
root@artem-test-puppet:/var/log/postgresql# su postgres -c psql
psql (16.3 (Ubuntu 16.3-1.pgdg22.04+1), server 15.8 (Ubuntu 15.8-1.pgdg22.04+1))
Type "help" for help.

postgres=# select * from test;
 c1
----
 1
(1 row)

postgres=#


- задание со звездочкой *: не удаляя существующий инстанс ВМ сделайте новый, поставьте на его PostgreSQL, удалите файлы с данными из /var/lib/postgres, перемонтируйте внешний диск который сделали ранее от первой виртуальной машины ко второй и запустите PostgreSQL на второй машине так чтобы он работал с данными на внешнем диске, расскажите как вы это сделали и что в итоге получилось.

> СОЗДАЛ НОВУЮ МАШИНУ artem-pg
```sh
root@artem-pg:~# hostname
artem-pg

root@artem-pg:~# date
Wed Sep 18 09:07:40 PM MSK 2024
```

> УСТАНАВЛИВАЮ POSTGRESQL

```sh
root@artem-pg:~# apt-get install postgresql-15
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following additional packages will be installed:
  libcommon-sense-perl libjson-perl libjson-xs-perl libllvm15 libpq5 libsensors-config libsensors5 libtypes-serialiser-perl postgresql-client-15 postgresql-client-common postgresql-common
  ssl-cert sysstat
Suggested packages:
  lm-sensors postgresql-doc-15 isag
The following NEW packages will be installed:
  libcommon-sense-perl libjson-perl libjson-xs-perl libllvm15 libpq5 libsensors-config libsensors5 libtypes-serialiser-perl postgresql-15 postgresql-client-15 postgresql-client-common
  postgresql-common ssl-cert sysstat
0 upgraded, 14 newly installed, 0 to remove and 34 not upgraded.
Need to get 45.4 MB of archives.
After this operation, 184 MB of additional disk space will be used.
Do you want to continue? [Y/n] y
Get:1 https://repo.ocs.ru/repository/apt_ubuntu jammy/main amd64 libjson-perl all 4.04000-1 [81.8 kB]
Get:2 https://repo.ocs.ru/repository/apt_postgresql jammy-pgdg/main amd64 postgresql-client-common all 262.pgdg22.04+1 [94.8 kB]
Get:3 https://repo.ocs.ru/repository/apt_ubuntu jammy/main amd64 ssl-cert all 1.1.2 [17.4 kB]
Get:4 https://repo.ocs.ru/repository/apt_postgresql jammy-pgdg/main amd64 postgresql-common all 262.pgdg22.04+1 [240 kB]
Get:5 https://repo.ocs.ru/repository/apt_ubuntu jammy/main amd64 libcommon-sense-perl amd64 3.75-2build1 [21.1 kB]
Get:6 https://repo.ocs.ru/repository/apt_ubuntu jammy/main amd64 libtypes-serialiser-perl all 1.01-1 [11.6 kB]
Get:7 https://repo.ocs.ru/repository/apt_ubuntu jammy/main amd64 libjson-xs-perl amd64 4.030-1build3 [87.2 kB]
Get:8 https://repo.ocs.ru/repository/apt_ubuntu jammy-security/main amd64 libllvm15 amd64 1:15.0.7-0ubuntu0.22.04.3 [25.4 MB]
Get:9 https://repo.ocs.ru/repository/apt_postgresql jammy-pgdg/main amd64 libpq5 amd64 16.4-1.pgdg22.04+1 [217 kB]
Get:10 https://repo.ocs.ru/repository/apt_ubuntu jammy/main amd64 libsensors-config all 1:3.6.0-7ubuntu1 [5,274 B]
Get:11 https://repo.ocs.ru/repository/apt_ubuntu jammy/main amd64 libsensors5 amd64 1:3.6.0-7ubuntu1 [26.3 kB]
Get:12 https://repo.ocs.ru/repository/apt_postgresql jammy-pgdg/main amd64 postgresql-client-15 amd64 15.8-1.pgdg22.04+1 [1,689 kB]
Get:13 https://repo.ocs.ru/repository/apt_postgresql jammy-pgdg/main amd64 postgresql-15 amd64 15.8-1.pgdg22.04+1 [17.1 MB]
Get:14 https://repo.ocs.ru/repository/apt_ubuntu jammy-security/main amd64 sysstat amd64 12.5.2-2ubuntu0.2 [487 kB]
Fetched 45.4 MB in 5s (8,675 kB/s)
Preconfiguring packages ...
Selecting previously unselected package libjson-perl.
(Reading database ... 123897 files and directories currently installed.)
Preparing to unpack .../00-libjson-perl_4.04000-1_all.deb ...
Unpacking libjson-perl (4.04000-1) ...
Selecting previously unselected package postgresql-client-common.
Preparing to unpack .../01-postgresql-client-common_262.pgdg22.04+1_all.deb ...
Unpacking postgresql-client-common (262.pgdg22.04+1) ...
Selecting previously unselected package ssl-cert.
Preparing to unpack .../02-ssl-cert_1.1.2_all.deb ...
Unpacking ssl-cert (1.1.2) ...
Selecting previously unselected package postgresql-common.
Preparing to unpack .../03-postgresql-common_262.pgdg22.04+1_all.deb ...
Adding 'diversion of /usr/bin/pg_config to /usr/bin/pg_config.libpq-dev by postgresql-common'
Unpacking postgresql-common (262.pgdg22.04+1) ...
Selecting previously unselected package libcommon-sense-perl:amd64.
Preparing to unpack .../04-libcommon-sense-perl_3.75-2build1_amd64.deb ...
Unpacking libcommon-sense-perl:amd64 (3.75-2build1) ...
Selecting previously unselected package libtypes-serialiser-perl.
Preparing to unpack .../05-libtypes-serialiser-perl_1.01-1_all.deb ...
Unpacking libtypes-serialiser-perl (1.01-1) ...
Selecting previously unselected package libjson-xs-perl.
Preparing to unpack .../06-libjson-xs-perl_4.030-1build3_amd64.deb ...
Unpacking libjson-xs-perl (4.030-1build3) ...
Selecting previously unselected package libllvm15:amd64.
Preparing to unpack .../07-libllvm15_1%3a15.0.7-0ubuntu0.22.04.3_amd64.deb ...
Unpacking libllvm15:amd64 (1:15.0.7-0ubuntu0.22.04.3) ...
Selecting previously unselected package libpq5:amd64.
Preparing to unpack .../08-libpq5_16.4-1.pgdg22.04+1_amd64.deb ...
Unpacking libpq5:amd64 (16.4-1.pgdg22.04+1) ...
Selecting previously unselected package libsensors-config.
Preparing to unpack .../09-libsensors-config_1%3a3.6.0-7ubuntu1_all.deb ...
Unpacking libsensors-config (1:3.6.0-7ubuntu1) ...
Selecting previously unselected package libsensors5:amd64.
Preparing to unpack .../10-libsensors5_1%3a3.6.0-7ubuntu1_amd64.deb ...
Unpacking libsensors5:amd64 (1:3.6.0-7ubuntu1) ...
Selecting previously unselected package postgresql-client-15.
Preparing to unpack .../11-postgresql-client-15_15.8-1.pgdg22.04+1_amd64.deb ...
Unpacking postgresql-client-15 (15.8-1.pgdg22.04+1) ...
Selecting previously unselected package postgresql-15.
Preparing to unpack .../12-postgresql-15_15.8-1.pgdg22.04+1_amd64.deb ...
Unpacking postgresql-15 (15.8-1.pgdg22.04+1) ...
Selecting previously unselected package sysstat.
Preparing to unpack .../13-sysstat_12.5.2-2ubuntu0.2_amd64.deb ...
Unpacking sysstat (12.5.2-2ubuntu0.2) ...
Setting up postgresql-client-common (262.pgdg22.04+1) ...
Setting up libsensors-config (1:3.6.0-7ubuntu1) ...
Setting up libpq5:amd64 (16.4-1.pgdg22.04+1) ...
Setting up libcommon-sense-perl:amd64 (3.75-2build1) ...
Setting up postgresql-client-15 (15.8-1.pgdg22.04+1) ...
update-alternatives: using /usr/share/postgresql/15/man/man1/psql.1.gz to provide /usr/share/man/man1/psql.1.gz (psql.1.gz) in auto mode
Setting up ssl-cert (1.1.2) ...
Setting up libsensors5:amd64 (1:3.6.0-7ubuntu1) ...
Setting up libtypes-serialiser-perl (1.01-1) ...
Setting up libllvm15:amd64 (1:15.0.7-0ubuntu0.22.04.3) ...
Setting up libjson-perl (4.04000-1) ...
Setting up sysstat (12.5.2-2ubuntu0.2) ...

Creating config file /etc/default/sysstat with new version
update-alternatives: using /usr/bin/sar.sysstat to provide /usr/bin/sar (sar) in auto mode
Created symlink /etc/systemd/system/sysstat.service.wants/sysstat-collect.timer → /lib/systemd/system/sysstat-collect.timer.
Created symlink /etc/systemd/system/sysstat.service.wants/sysstat-summary.timer → /lib/systemd/system/sysstat-summary.timer.
Created symlink /etc/systemd/system/multi-user.target.wants/sysstat.service → /lib/systemd/system/sysstat.service.
Setting up libjson-xs-perl (4.030-1build3) ...
Setting up postgresql-common (262.pgdg22.04+1) ...
Adding user postgres to group ssl-cert

Creating config file /etc/postgresql-common/createcluster.conf with new version
Building PostgreSQL dictionaries from installed myspell/hunspell packages...
Removing obsolete dictionary files:
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service → /lib/systemd/system/postgresql.service.
Setting up postgresql-15 (15.8-1.pgdg22.04+1) ...
Creating new PostgreSQL cluster 15/main ...
/usr/lib/postgresql/15/bin/initdb -D /var/lib/postgresql/15/main --auth-local peer --auth-host scram-sha-256 --no-instructions
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/15/main ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Europe/Moscow
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok
Processing triggers for man-db (2.10.2-1) ...
Processing triggers for libc-bin (2.35-0ubuntu3.8) ...
Scanning processes...
Scanning linux images...

Running kernel seems to be up-to-date.

No services need to be restarted.

No containers need to be restarted.

No user sessions are running outdated binaries.

No VM guests are running outdated hypervisor (qemu) binaries on this host.
```

> ПРОВЕРЯЮ СТАТУС POSTGRESQL

```sh
root@artem-pg:~# systemctl status postgresql
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/lib/systemd/system/postgresql.service; enabled; vendor preset: enabled)
     Active: active (exited) since Wed 2024-09-18 21:10:55 MSK; 33s ago
   Main PID: 14372 (code=exited, status=0/SUCCESS)
        CPU: 3ms

Sep 18 21:10:55 artem-pg systemd[1]: Starting PostgreSQL RDBMS...
Sep 18 21:10:55 artem-pg systemd[1]: Finished PostgreSQL RDBMS.
```

> ВЫКЛЮЧАЮ PostgreSQL И УДАЛЯЮ ВСЕ ФАЙЛЫ ИЗ КАТАЛОГА /var/lib/postgresql/15/
```sh
root@artem-pg:~# systemctl stop postgresql
root@artem-pg:~# rm -rf /var/lib/postgresql/15/
root@artem-pg:~# cd /var/lib/postgresql/
root@artem-pg:/var/lib/postgresql# ls -la
total 8
drwxr-xr-x  2 postgres postgres 4096 Sep 18 21:11 .
drwxr-xr-x 44 root     root     4096 Sep 18 21:10 ..
```

> СМОТРЮ ЧТО ПО ДИСКАМ НА НОВОЙ МАШИНЕ

```sh
root@artem-pg:/var/lib/postgresql# lsblk
NAME             MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0              7:0    0  63.4M  1 loop /snap/core20/1974
loop1              7:1    0 111.9M  1 loop /snap/lxd/24322
loop2              7:2    0  53.3M  1 loop /snap/snapd/19457
sda                8:0    0    40G  0 disk
├─sda1             8:1    0     1M  0 part
├─sda2             8:2    0     1G  0 part /boot
└─sda3             8:3    0    39G  0 part
  ├─vg00-lv_root 253:0    0    15G  0 lvm  /
  ├─vg00-lv_home 253:1    0     2G  0 lvm  /home
  ├─vg00-lv_opt  253:2    0     5G  0 lvm  /opt
  ├─vg00-lv_var  253:3    0     5G  0 lvm  /var
  └─vg00-lv_swap 253:4    0     4G  0 lvm  [SWAP]
```


> ОТКЛЮЧАЮ ДИСК НА СТАРОЙ МАШИНЕ artem-test-puppet
```sh
root@artem-test-puppet:/var/log/postgresql# lsblk
NAME             MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0              7:0    0  63.4M  1 loop /snap/core20/1974
loop1              7:1    0 111.9M  1 loop /snap/lxd/24322
loop2              7:2    0  53.3M  1 loop /snap/snapd/19457
sda                8:0    0    40G  0 disk
├─sda1             8:1    0     1M  0 part
├─sda2             8:2    0     1G  0 part /boot
└─sda3             8:3    0    39G  0 part
  ├─vg00-lv_root 253:0    0    15G  0 lvm  /
  ├─vg00-lv_home 253:1    0     2G  0 lvm  /home
  ├─vg00-lv_opt  253:2    0     5G  0 lvm  /opt
  ├─vg00-lv_var  253:3    0     5G  0 lvm  /var
  └─vg00-lv_swap 253:4    0     4G  0 lvm  [SWAP]
sdb                8:16   0    10G  0 disk
└─data-lv_data   253:5    0    10G  0 lvm  /mnt/data
```

> ВЫКЛЮЧАЮ PostgreSQL

```sh
root@artem-test-puppet:/var/log/postgresql# systemctl stop postgresql
root@artem-test-puppet:/var/log/postgresql# systemctl status postgresql
○ postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/lib/systemd/system/postgresql.service; enabled; vendor preset: enabled)
     Active: inactive (dead) since Wed 2024-09-18 21:18:26 MSK; 7s ago
    Process: 3735 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
   Main PID: 3735 (code=exited, status=0/SUCCESS)
        CPU: 1ms

Sep 18 18:36:29 artem-test-puppet systemd[1]: Starting PostgreSQL RDBMS...
Sep 18 18:36:29 artem-test-puppet systemd[1]: Finished PostgreSQL RDBMS.
Sep 18 21:18:26 artem-test-puppet systemd[1]: postgresql.service: Deactivated successfully.
Sep 18 21:18:26 artem-test-puppet systemd[1]: Stopped PostgreSQL RDBMS.

```

> ОТКЛЮЧАЮ ДИСК /mnt/data. дИСК НЕ СРАЗУ УДАЛОСЬ ОТМОНТИРОВАТЬ, ПРИШЛОСЬ УБИВАТЬ РЯД ПРОЦЕССОВ

```sh
root@artem-test-puppet:/var/log/postgresql# umount /mnt/data
umount: /mnt/data: target is busy.
root@artem-test-puppet:/var/log/postgresql# lsof | grep /mnt/data/
postgres  3852                       postgres  cwd       DIR              253,5      4096     393217 /mnt/data/main
postgres  3853                       postgres  cwd       DIR              253,5      4096     393217 /mnt/data/main
postgres  3853                       postgres    4u      REG              253,5  16777216     393220 /mnt/data/main/pg_wal/000000010000000000000001
postgres  3854                       postgres  cwd       DIR              253,5      4096     393217 /mnt/data/main
postgres  3856                       postgres  cwd       DIR              253,5      4096     393217 /mnt/data/main
postgres  3856                       postgres    4u      REG              253,5  16777216     393220 /mnt/data/main/pg_wal/000000010000000000000001
postgres  3857                       postgres  cwd       DIR              253,5      4096     393217 /mnt/data/main
postgres  3857                       postgres    4u      REG              253,5      8192     393223 /mnt/data/main/global/1262
postgres  3858                       postgres  cwd       DIR              253,5      4096     393217 /mnt/data/main
postgres  3858                       postgres    4u      REG              253,5         0     393233 /mnt/data/main/global/6100
root@artem-test-puppet:/var/log/postgresql# ps aux | grep postgres
postgres    3852  0.0  1.5 219256 30296 ?        Ss   18:43   0:00 /usr/lib/postgresql/15/bin/postgres -D /mnt/data/main -c config_file=/etc/postgresql/15/main/postgresql.conf
postgres    3853  0.0  0.4 219384  8240 ?        Ss   18:43   0:00 postgres: 15/main: checkpointer
postgres    3854  0.0  0.3 219400  6740 ?        Ss   18:43   0:00 postgres: 15/main: background writer
postgres    3856  0.0  0.5 219256 11300 ?        Ss   18:43   0:00 postgres: 15/main: walwriter
postgres    3857  0.0  0.4 220844  9172 ?        Ss   18:43   0:00 postgres: 15/main: autovacuum launcher
postgres    3858  0.0  0.3 220828  7396 ?        Ss   18:43   0:00 postgres: 15/main: logical replication launcher
root        7050  0.0  0.1   6612  2400 pts/1    S+   21:20   0:00 grep --color=auto postgres
root@artem-test-puppet:/var/log/postgresql# kill 3852
root@artem-test-puppet:/var/log/postgresql# kill 3853
-bash: kill: (3853) - No such process
root@artem-test-puppet:/var/log/postgresql# ps aux | grep postgres
root        7055  0.0  0.1   6612  2388 pts/1    S+   21:21   0:00 grep --color=auto postgres
root@artem-test-puppet:/var/log/postgresql# umount /mnt/data

```

> ЗАКОММЕНТИРУЮ СТРОЧКУ ПРО ДИСК /mnt/datanano В ФАЙЛЕ /etc/fstab И ОТКЛЮЧУ ЭТОТ ДИСК ОТ СЕРВЕРА artem-test-puppet И ПОДКЛЮЧУ К НОВОЙ МАШИНЕ artem-pg

> УБЕЖДАЮСЬ, ЧТО ДИСК ЕЩЕ ЕСТЬ НА СТАРОЙ МАШИНЕ

```sh
root@artem-test-puppet:/var/log/postgresql# lsblk
NAME             MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0              7:0    0  63.4M  1 loop /snap/core20/1974
loop1              7:1    0 111.9M  1 loop /snap/lxd/24322
loop2              7:2    0  53.3M  1 loop /snap/snapd/19457
sda                8:0    0    40G  0 disk
├─sda1             8:1    0     1M  0 part
├─sda2             8:2    0     1G  0 part /boot
└─sda3             8:3    0    39G  0 part
  ├─vg00-lv_root 253:0    0    15G  0 lvm  /
  ├─vg00-lv_home 253:1    0     2G  0 lvm  /home
  ├─vg00-lv_opt  253:2    0     5G  0 lvm  /opt
  ├─vg00-lv_var  253:3    0     5G  0 lvm  /var
  └─vg00-lv_swap 253:4    0     4G  0 lvm  [SWAP]
sdb                8:16   0    10G  0 disk
└─data-lv_data   253:5    0    10G  0 lvm
```


> ДИСК ОТКЛЮЧЕН
```sh
root@artem-test-puppet:/var/log/postgresql# lsblk
NAME             MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0              7:0    0  63.4M  1 loop /snap/core20/1974
loop1              7:1    0 111.9M  1 loop /snap/lxd/24322
loop2              7:2    0  53.3M  1 loop /snap/snapd/19457
sda                8:0    0    40G  0 disk
├─sda1             8:1    0     1M  0 part
├─sda2             8:2    0     1G  0 part /boot
└─sda3             8:3    0    39G  0 part
  ├─vg00-lv_root 253:0    0    15G  0 lvm  /
  ├─vg00-lv_home 253:1    0     2G  0 lvm  /home
  ├─vg00-lv_opt  253:2    0     5G  0 lvm  /opt
  ├─vg00-lv_var  253:3    0     5G  0 lvm  /var
  └─vg00-lv_swap 253:4    0     4G  0 lvm  [SWAP]
```

> ПОДКЛЮЧИЛ ДИСК К НОВОЙ МАШИНЕ

```sh
root@artem-pg:/var/lib/postgresql# lsblk
NAME             MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0              7:0    0  63.4M  1 loop /snap/core20/1974
loop1              7:1    0 111.9M  1 loop /snap/lxd/24322
loop2              7:2    0  53.3M  1 loop /snap/snapd/19457
sda                8:0    0    40G  0 disk
├─sda1             8:1    0     1M  0 part
├─sda2             8:2    0     1G  0 part /boot
└─sda3             8:3    0    39G  0 part
  ├─vg00-lv_root 253:0    0    15G  0 lvm  /
  ├─vg00-lv_home 253:1    0     2G  0 lvm  /home
  ├─vg00-lv_opt  253:2    0     5G  0 lvm  /opt
  ├─vg00-lv_var  253:3    0     5G  0 lvm  /var
  └─vg00-lv_swap 253:4    0     4G  0 lvm  [SWAP]
sdb                8:16   0    10G  0 disk
└─data-lv_data   253:5    0    10G  0 lvm
```

> ПРАВЛЮ ФАЙЛ /etc/fstab
```sh
/dev/mapper/data-lv_data /mnt/data  ext4 defaults 0 0
```

> СОЗДАЮ ПАПКУ /mnt/data

```sh
root@artem-pg:/var/lib/postgresql# mkdir /mnt/data
root@artem-pg:/var/lib/postgresql# ls -la /mnt/
total 12
drwxr-xr-x  3 root root 4096 Sep 18 21:30 .
drwxr-xr-x 20 root root 4096 Sep 18 21:04 ..
drwxr-xr-x  2 root root 4096 Sep 18 21:30 data
```

> ОТПРАВЛЯЮ СЕРВЕР НА ПЕРЕЗАГРУЗКУ

> УБЕЖДАЮСЬ, ЧТО ДИСК УСПЕШНО ПРИМОНТИРОВАЛСЯ
```sh
NAME             MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0              7:0    0 111.9M  1 loop /snap/lxd/24322
loop1              7:1    0  53.3M  1 loop /snap/snapd/19457
loop2              7:2    0  63.4M  1 loop /snap/core20/1974
sda                8:0    0    40G  0 disk
├─sda1             8:1    0     1M  0 part
├─sda2             8:2    0     1G  0 part /boot
└─sda3             8:3    0    39G  0 part
  ├─vg00-lv_root 253:0    0    15G  0 lvm  /
  ├─vg00-lv_home 253:1    0     2G  0 lvm  /home
  ├─vg00-lv_opt  253:2    0     5G  0 lvm  /opt
  ├─vg00-lv_var  253:3    0     5G  0 lvm  /var
  └─vg00-lv_swap 253:4    0     4G  0 lvm  [SWAP]
sdb                8:16   0    10G  0 disk
└─data-lv_data   253:5    0    10G  0 lvm  /mnt/data

root@artem-pg:~# mount | grep /mnt/data
/dev/mapper/data-lv_data on /mnt/data type ext4 (rw,relatime)
```

> ВЫДАЮ ПРАВА ВЛАДЕЛЬЦА POSTGRES НА КАТАЛОГ /mnt/data
```sh
root@artem-pg:~# chown -R postgres:postgres /mnt/data/
```

> ПРАВЛЮ ФАЙЛ /etc/postgresql/15/main/postgresql.conf меняю параметр data_directory
```sh
root@artem-pg:~# cat /etc/postgresql/15/main/postgresql.conf | grep data_dir
data_directory = '/mnt/data/main/'              # use data in another directory
```

> ЗАПУСКАЮ PostgreSQL
```sh
root@artem-pg:~# systemctl start postgresql
root@artem-pg:~# systemctl status postgresql
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/lib/systemd/system/postgresql.service; enabled; vendor preset: enabled)
     Active: active (exited) since Wed 2024-09-18 21:38:18 MSK; 5s ago
    Process: 2805 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
   Main PID: 2805 (code=exited, status=0/SUCCESS)
        CPU: 2ms

Sep 18 21:38:18 artem-pg systemd[1]: Starting PostgreSQL RDBMS...
Sep 18 21:38:18 artem-pg systemd[1]: Finished PostgreSQL RDBMS.
root@artem-pg:~#
root@artem-pg:~# pg_isready
/var/run/postgresql:5432 - accepting connections
root@artem-pg:~#
root@artem-pg:~# sudo -u postgres pg_lsclusters
Ver Cluster Port Status Owner    Data directory  Log file
15  main    5432 online postgres /mnt/data/main/ /var/log/postgresql/postgresql-15-main.log
root@artem-pg:~#
```


> ПРОВЕРЯЮ ЕСТЬ ЛИ ДАННЫЕ В БАЗЕ.

```sh
root@artem-pg:~# su postgres -c psql
could not change directory to "/root": Permission denied
psql (15.8 (Ubuntu 15.8-1.pgdg22.04+1))
Type "help" for help.

postgres=# select * from test;
 c1
----
 1
(1 row)

postgres=#
```

> ДИСК С БАЗОЙ СО СТАРОГО СЕРВЕРА УСПЕШНО ПЕРЕНЕС НА НОВЫЙ ДИСК БЕЗ ПОТЕРЯ ДАННЫХ
